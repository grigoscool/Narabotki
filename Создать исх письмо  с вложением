	НовыйЭПИ = Документы.ЭлектронноеПисьмоИсходящее.СоздатьДокумент();
	
	//5,1 получатели письма
	КИТ = РегистрыСведений.ИТПлНастройкиПрограммы.ПолучитьНастройку("ИТПл3PLОператор_КИТ");
	РольКИТ = РегистрыСведений.ИТПлНастройкиПрограммы.ПолучитьНастройку("КЛПеревозчикаРольПриемкаЗаявок");
	
	Запрос = Новый Запрос;
	Запрос.Текст = 
		"ВЫБРАТЬ
		|	ЕСТЬNULL(КонтактныеЛицаПартнеровКонтактнаяИнформация.Представление, """") КАК АдресаЭлПочты,
		|	КонтактныеЛицаПартнеров.Ссылка КАК Ссылка,
		|	КонтактныеЛицаПартнеров.Наименование КАК Наименование
		|ИЗ
		|	Справочник.КонтактныеЛицаПартнеров КАК КонтактныеЛицаПартнеров
		|		ВНУТРЕННЕЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров.РолиКонтактногоЛица КАК КонтактныеЛицаПартнеровРолиКонтактногоЛица
		|		ПО КонтактныеЛицаПартнеров.Ссылка = КонтактныеЛицаПартнеровРолиКонтактногоЛица.Ссылка
		|			И (НЕ КонтактныеЛицаПартнеров.ПометкаУдаления)
		|			И (КонтактныеЛицаПартнеровРолиКонтактногоЛица.РольКонтактногоЛица = &Роль)
		|		ЛЕВОЕ СОЕДИНЕНИЕ Справочник.КонтактныеЛицаПартнеров.КонтактнаяИнформация КАК КонтактныеЛицаПартнеровКонтактнаяИнформация
		|		ПО КонтактныеЛицаПартнеров.Ссылка = КонтактныеЛицаПартнеровКонтактнаяИнформация.Ссылка
		|			И (КонтактныеЛицаПартнеровКонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.АдресЭлектроннойПочты))
		|			И (КонтактныеЛицаПартнеровКонтактнаяИнформация.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.EmailКонтактногоЛица))
		|ГДЕ
		|	КонтактныеЛицаПартнеров.Владелец = &Владелец
		|
		|ОБЪЕДИНИТЬ ВСЕ
		|
		|ВЫБРАТЬ
		|	ПользователиКонтактнаяИнформация.Представление,
		|	ПользователиКонтактнаяИнформация.Ссылка,
		|	ПользователиКонтактнаяИнформация.Ссылка.Наименование
		|ИЗ
		|	Справочник.Пользователи.КонтактнаяИнформация КАК ПользователиКонтактнаяИнформация
		|ГДЕ
		|	ПользователиКонтактнаяИнформация.Ссылка = &ТекПользователь
		|	И ПользователиКонтактнаяИнформация.Тип = ЗНАЧЕНИЕ(Перечисление.ТипыКонтактнойИнформации.АдресЭлектроннойПочты)
		|	И ПользователиКонтактнаяИнформация.Вид = ЗНАЧЕНИЕ(Справочник.ВидыКонтактнойИнформации.EmailПользователя)";
	
	Запрос.УстановитьПараметр("Владелец", КИТ);
	Запрос.УстановитьПараметр("Роль", РольКИТ);
	Запрос.УстановитьПараметр("ТекПользователь", Пользователи.ТекущийПользователь());
	
	РезультатЗапроса = Запрос.Выполнить();
	
	Выборка = РезультатЗапроса.Выбрать();
	
	Пока Выборка.Следующий() Цикл
		Адреса = Выборка.АдресаЭлПочты;
		МассивАдресов = СтрРазделить(Адреса, ";", Ложь);
		Для каждого АдресЭП Из МассивАдресов Цикл
			СтрокаПолучатели = НовыйЭПИ.ПолучателиПисьма.Добавить();
			СтрокаПолучатели.Адрес = СокрЛП(АдресЭП);
			СтрокаПолучатели.Контакт = Выборка.Ссылка; 
			СтрокаПолучатели.Представление = Выборка.Наименование; 
		КонецЦикла;
	КонецЦикла;
	
	// 5,3 отправитель письма
	УчетнаяЗаписьЭП = Справочники.УчетныеЗаписиЭлектроннойПочты.СистемнаяУчетнаяЗаписьЭлектроннойПочты;
	НовыйЭПИ.УчетнаяЗапись = УчетнаяЗаписьЭП;
	// 5,4 тема и тело письма
	МассивИменПФ = Новый Массив;
	Для Каждого Элемент Из ОбъектыПечати Цикл
		МассивИменПФ.Добавить(ИмяФайлаПечатнойФормы(Элемент.Значение, Параметры.ИсточникДанных.ИмяОбъекта));
	КонецЦикла;
	ТемаДокумента = СтрСоединить(МассивИменПФ, "; ");
	НовыйЭПИ.Тема = ТемаДокумента;
	НовыйЭПИ.Текст = ТемаДокумента;
	// 5,5 ответственный
	НовыйЭПИ.Ответственный = ПараметрыСеанса.ТекущийПользователь;
	
		НовыйЭПИ.Записать();

	// 5,2 к письму прикрепить файл
	ТабДок = ТекущаяПечатнаяФорма;
	ИмяОбъекта = Параметры.ИсточникДанных.ИмяОбъекта;
	ПолныйПутьКФайлу = КаталогВременныхФайлов() + ИмяОбъекта;
	Табдок.Записать(ПолныйПутьКФайлу, ТипФайлаПакетаОтображаемыхДокументов.XLS);
	Данные = Новый ДвоичныеДанные(ПолныйПутьКФайлу);

	АдресДанных = ПоместитьВоВременноеХранилище(Данные);
	//ПутьКФайлуНаСервере = ПолучитьИмяВременногоФайла("xls");
	//Файл[1].Записать(ПутьКФайлуНаСервере);
	ПараметрыФайла = Новый Структура("ВладелецФайлов,ИмяБезРасширения,РасширениеБезТочки,"
		+ "ВремяИзмененияУниверсальное,Автор",
		НовыйЭПИ.Ссылка,
		ИмяОбъекта,
		"xls",
		ТекущаяДатаСеанса(),
		Пользователи.ТекущийПользователь());
	РаботаСФайлами.ДобавитьФайл(ПараметрыФайла, АдресДанных);

	// 5,6 отправить
	НовыйЭПИ.СтатусПисьма = Перечисления.СтатусыИсходящегоЭлектронногоПисьма.Исходящее;
