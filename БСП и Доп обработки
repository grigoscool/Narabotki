Четыре вида групп назначаемых команд (подменю):


ДополнительныеОтчетыИОбработкиЗаполнениеОбъекта;
ДополнительныеОтчетыИОбработкиОтчеты;
ДополнительныеОтчетыИОбработкиПечатныеФормы;
ДополнительныеОтчетыИОбработкиСозданиеСвязанныхОбъектов.



Выбор сценария реализации дополнительной функциональности


1. Выбор вида обработки

2. Выбор варианта запуска обработки

Если нужно с пользователем общаться активно, выспрашивать у него данные, что-то уточнять – удобнее всего будет использовать опять же «ОткрытиеФормы»;
Если ничего у пользователя выспрашивать не надо, но вот действие, которые Вы запланировали – оно должно произойти на клиентской машине – тогда смело используйте «ВызовКлиентскогоМетода». Примеры: печать на основе офисных документов требует запуска самого приложения на клиентской машине; ввод на основании чаще всего должен приводить к открытию формы создаваемого документа на клиентской машине. И т.п.
Если все что нужно для Вашей обработки итак известно, а действия обработка должна совершить в базе данных – выбирайте «ВызовСерверногоМетода», а если при этом речь идет о заполнении формы – выбирайте «ЗаполнениеФормы». Обратите внимание – как ни странно, но вариант «ЗаполнениеФормы» отрабатывается системой в модуле объекта обработки, то есть пообщаться с пользователем в процессе отработки не получиться. Фактически «ЗаполнениеФормы» - разновидность серверного метода обработки.




Описание приемов реализации дополнительной функциональности




Вариант запуска «Открытие формы»

Для этого варианта запуска необходимо создать форму обработки (отчета) с двумя параметрами

- ИдентификаторКоманды (тип «Строка»)

- ДополнительнаяОбработкаСсылка (тип «СправочникСсылка.ДополнительныеОтчетыИОбработки»)

Эта форма и будет открываться при выполнении обработки.

Кроме того:

● Для назначаемых отчетов и обработок – в форме обработки необходимо добавить параметр «ОбъектыНазначения» типа <Произвольный>. В этот параметр будет передан массив ссылок на объекты, для которых выполняется дополнительная обработка.




Заполнением значений параметров перед открытием формы будет занимать сама подсистема. А если вышеуказанные параметры сделать «ключевыми» - то в любой момент, когда их значения Вам понадобятся в модуле формы – они к Вашим услугам.

Вариант запуска «Вызов клиентского метода»

Для этого варианта запуска необходимо создать форму обработки и в модуле формы обработки завести экспортную процедуру определенного вида.

● Для глобальных отчетов и обработок – реализовать экспортную процедуру ВыполнитьКоманду с параметром «ИдентификаторКоманды». В процессе исполнения в этот параметр система положит строку с идентификатором команды.

&НаКлиенте

ПроцедураВыполнитьКоманду(ИдентификаторКоманды)

// Реализация логики команды

// ...

КонецПроцедуры

● Для назначаемых обработок типа «ПечатнаяФорма» – реализовать экспортную процедуру Печать с двумя параметрами «ИдентификаторКоманды» и «ОбъектыНазначенияМассив», где ИдентификаторКоманды – строка, идентификатор команды, ОбъектыНазначенияМассив – массив, ссылок на объекты информационной базы, для которых выполняется дополнительная обработка.

&НаКлиенте

Процедура Печать(ИдентификаторКоманды,ОбъектыНазначенияМассив)

// Реализация логики команды печати

// ...

КонецПроцедуры

● Для назначаемых обработок типа «Создание связанных объектов» – реализовать экспортную процедуру «ВыполнитьКоманду» с параметрами «ИдентификаторКоманды», «ОбъектыНазначенияМассив» и «СозданныеОбъекты», где СозданныеОбъекты – массив ссылок на созданные объекты.

&НаКлиенте

Процедура ВыполнитьКоманду(ИдентификаторКоманды,ОбъектыНазначенияМассив,СозданныеОбъекты)

// Реализация логики команды по созданию связанных объектов

// ...

КонецПроцедуры


● Для назначаемых обработок типа «Заполнение объекта» и «Отчет» – реализовать экспортную процедуру «ВыполнитьКоманду» с параметрами «ИдентификаторКоманды», «ОбъектыНазначенияМассив».

&НаКлиенте

Процедура ВыполнитьКоманду(ИдентификаторКоманды,ОбъектыНазначенияМассив)

// Реализация логики команды по заполнению объекта

// ...

КонецПроцедуры

Кроме того, посредством свойства формы «ВладелецФормы» можно добраться до контекста формы объекта назначения.


Вариант запуска «Вызов серверного метода»

Для этого варианта запуска необходимо в модуле обработки завести экспортную процедуру определенного вида:

● Для глобальных отчетов и глобальных обработок – реализовать экспортную процедуру «ВыполнитьКоманду» с параметром «ИдентификаторКоманды» и «ПараметрыВыполненияКоманды». Последний параметр - это структура с ключом "ДополнительнаяОбработкаСсылка", в котором содержится ссылка на элемент справочника, содержащего данную обработку.

Процедура ВыполнитьКоманду(ИдентификаторКоманды,ПараметрыВыполненияКоманды) Экспорт

// Реализация логики команды

Если ИдентификаторКоманды=... Тогда

...

ИначеЕсли

...

КонецЕсли

КонецПроцедуры


● Для назначаемых обработок типа «Создание связанных объектов» – реализовать экспортную процедуру «ВыполнитьКоманду» с параметрами «ИдентификаторКоманды», «ОбъектыНазначения», «СозданныеОбъекты» и «ПараметрыВыполненияКоманды».

Процедура ВыполнитьКоманду(ИдентификаторКоманды,ОбъектыНазначения,СозданныеОбъекты,ПараметрыВыполненияКоманды) Экспорт

// Реализация логики команды по созданию связанных объектов

Если ИдентификаторКоманды=... Тогда

...

ИначеЕсли

...

КонецЕсли

КонецПроцедуры


● Для назначаемых обработок типа «Печать» на основе табличных документов – реализовать экспортную процедуру «Печать» с параметрами «МассивОбъектов», «КоллекцияПечатныхФорм», «ОбъектыПечати», «ПараметрыВывода».

Процедура Печать(МассивОбъектов,КоллекцияПечатныхФорм,ОбъектыПечати,ПараметрыВывода) Экспорт

// Реализация логики команды печати

Если ИдентификаторКоманды=... Тогда

...

ИначеЕсли

...

КонецЕсли

КонецПроцедуры



● Для назначаемых обработок типа «Заполнение объекта» и других типов обработок – реализовать экспортную процедуру «ВыполнитьКоманду» с параметрами «ИдентификаторКоманды», «ОбъектыНазначения» и «ПараметрыВыполненияКоманды»..

Процедура ВыполнитьКоманду(ИдентификаторКоманды,ОбъектыНазначения,ПараметрыВыполненияКоманды) Экспорт

// Реализация логики команды по заполнению объекта

Если ИдентификаторКоманды=... Тогда

...

ИначеЕсли

...

КонецЕсли

КонецПроцедуры


Вариант запуска «Заполнение формы»

Для этого варианта запуска необходимо в модуле обработки завести экспортную процедуру экспортную процедуру «ВыполнитьКоманду» с параметрами «ИдентификаторКоманды», «ОбъектыНазначения» и «ПараметрыКоманды». Как раз в коллекции «ПараметрыКоманды» по ключу «ЭтаФорма» можно выйти на контекст формы объекта вызова. Все что Вы измените в данной форме – подсистема самостоятельно отобразит пользователю.

Процедура ВыполнитьКоманду(ИдентификаторКоманды,ОбъектыНазначения, ПараметрыКоманды) Экспорт

КонтекстФормыВызова = ПараметрыКоманды.ЭтаФорма;

ДанныеОбъекта = КонтекстФормыВызова.Объект;

//теперь можно вносить изменения в ДанныеОбъекта

...

КонецПроцедуры




Методика подготовки формы объекта для работы с заполнением и другими вариантами дополнительных обработок


1) В обработчике «ПриСозданииНаСервере» должен вызывался стандартный алгоритм формирования подменю заполнения:


&НаСервере

Процедура ПриСозданииНаСервере(Отказ, СтандартнаяОбработка)

…

// СтандартныеПодсистемы.ДополнительныеОтчетыИОбработки

ДополнительныеОтчетыИОбработки.ПриСозданииНаСервере(ЭтотОбъект);

// Конец СтандартныеПодсистемы.ДополнительныеОтчетыИОбработки

…

КонецПроцедуры




2) В модуле формы объекта должна присутствовать процедура «Подключаемый_ВыполнитьНазначаемуюКоманду» с именно такими названием и текстом:



&НаКлиенте

Процедура Подключаемый_ВыполнитьНазначаемуюКоманду(Команда)

Если НЕ ДополнительныеОтчетыИОбработкиКлиент.ВыполнитьНазначаемуюКомандуНаКлиенте(

ЭтотОбъект, Команда.Имя) Тогда

РезультатВыполнения = Неопределено;

ДополнительныеОтчетыИОбработкиВыполнитьНазначаемуюКомандуНаСервере(

Команда.Имя, РезультатВыполнения);

ДополнительныеОтчетыИОбработкиКлиент.ПоказатьРезультатВыполненияКоманды(

ЭтотОбъект, РезультатВыполнения);

КонецЕсли;

КонецПроцедуры



3) В модуле формы объекта должна присутствовать процедура «ДополнительныеОтчетыИОбработкиВыполнитьНазначаемуюКомандуНаСервере» с именно такими названием и текстом:



&НаСервере

Процедура ДополнительныеОтчетыИОбработкиВыполнитьНазначаемуюКомандуНаСервере(

ИмяЭлемента, РезультатВыполнения)

ДополнительныеОтчетыИОбработки.ВыполнитьНазначаемуюКомандуНаСервере(

ЭтотОбъект, ИмяЭлемента, РезультатВыполнения);

КонецПроцедуры


Методика разработки внешних печатных форм при необходимости общения с пользователем

1) Клонировать шаблон обработки «ШаблонВнешнейНазначаемойОбработкиЗаполненияОткрытиеФормы». В функции «СведенияОВнешнейОбработке» исправить Вид обработки на «ПечатнаяФорма».


2) Создать в форме обработки реквизиты для общения с пользователем и команду «Печать» с обработчиком на клиенте.


3) Создать или скопировать в обработку макет и функцию, готовящую табличный документ. При этом функция должна получать макет строго из обработки, а параметр для запроса должен заполняться из «Параметры.ОбъектыНазначения».


4) Скопировать в процедуру «Печать» содержимое любой процедуры, вызывающей «МодульУправлениеПечатьюКлиент.ПечатьДокументов(»


5) Обеспечить взаимодействие всех скопированных частей в интересах решения задачи.
